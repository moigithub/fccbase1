'use strict';
/*
router.get('/', controller.index);
router.get('/:id', controller.show);
router.post('/', controller.create);
router.put('/:id', controller.update);
router.patch('/:id', controller.update);
router.delete('/:id', controller.destroy);
*/
angular.module('base0App')  //, 
  .controller('viewPollVotesCtrl', [ '$scope', '$http', '$routeParams', 'Auth' ,function ($scope, $http, $routeParams, Auth) {  //$location, 
    $scope.polls={"pollOptions":[],
                  "usersVote":[],
                  "pollName":"",
                  "createdBy":""
                  };
    $scope.error=null;
    $scope.choice={};

    $scope.getCurrentUser = Auth.getCurrentUser();
    $scope.loggedIn = Auth.isLoggedIn();

///////// chartjs

    $scope.labels = ["chart"];
    //$scope.series = ['Series A', 'Series B'];
    $scope.data = [0];
    //$scope.type = 'Pie';

/*
    $scope.onClick = function (points, evt) {
      console.log(points, evt);
    };
*/
    var calcVotes = function(data){
      return data.pollOptions.map(function(option){
          return data.usersVote.filter(function(vote){ 
          //  console.log(vote.pollName," : ",option, vote);
            return vote.pollOption===option;
          }).length;
        }); 
    }
/////////// fin chart js



    $http.get('/api/votes/' + $routeParams.id)
    .success(function(data){
        $scope.polls=data;
        //console.log("data", data);
        // chart data
        $scope.labels = $scope.polls.pollOptions;
        

        //console.log("Options: ",data.pollOptions);
        //$scope.data   = $scope.polls.usersVote;

        // count votes for each poll
        
        $scope.data   = calcVotes(data);
        

        //console.log("scope data", $scope.data);
/*
        {"uid": $scope.getCurrentUser._id, 
        "pollName":$scope.choice.vote}
*/
        // fin chart data
    })
    .error(function(data, status) {
        $scope.error=status;
    });

    $scope.validChoice = function(){
      return Object.keys($scope.choice).length<1;
    }

    $scope.submit = function(){
        //console.log($scope.polls);
        //console.log($scope.choice);
        // if no hay choice.. errror

        // if el user ya voto.. cambiar voto
        // remove user vote.. if exist, then add again
        // aka. change vote. not allow vote twice+
        var votes = $scope.polls["usersVote"].filter(function(userVote){
          return userVote.uid !== $scope.getCurrentUser._id
        });


        votes.push({"uid": $scope.getCurrentUser._id, "pollOption":$scope.choice.vote});
        //console.log(votes);

        // update userVotes
        $scope.polls["usersVote"] = votes;

        //console.log($scope.polls);

        // update
//        $http.put('/api/votes/'+$scope.polls._id, $scope.polls).
        $http.put('/api/votes/'+$scope.polls._id, {"usersVote": votes} ).
        success(function(data, status, headers, config) {
          // this callback will be called asynchronously
          // when the response is available
          //console.log("put OK", status, headers,data);
          $scope.data   = calcVotes(data);
        }).
        error(function(data, status, headers, config) {
          // called asynchronously if an error occurs
          // or server returns response with an error status.
          //console.log("error ", status, headers);
        });
        
    }
  }]);
/*
    $scope.delete = function(pollId){
        $http.delete('/api/votes/' + pollId);
        // redirect to /votes/mypoll to refresh the list ???
    }
*/

  /*
  var VotesSchema = new Schema({
    // _id: Number // autogenerated 
    createdBy:String,
    pollName: String,
    pollOptions: Array,
    usersVote: Array  // {uid:_id,pollName,""}
    //placeholders: Array
});*/
/*
angular.module("base0App", ["chart.js"]).controller("PolarAreaCtrl", function ($scope) {
  $scope.labels = ["Download Sales", "In-Store Sales", "Mail-Order Sales", "Tele Sales", "Corporate Sales"];
  $scope.data = [300, 500, 100, 40, 120];
});
*/